From 727e23218aa8be87f408f0f88ae8a10e376dfd89 Mon Sep 17 00:00:00 2001
From: Valentin Raevsky <valentin@compulab.co.il>
Date: Thu, 25 Jun 2020 10:54:27 +0300
Subject: [PATCH 49/49] mcm-imx8m-mini: dst: Add sbc-mcm-imx8m-mini-rs485.dts

Signed-off-by: Valentin Raevsky <valentin@compulab.co.il>
---
 arch/arm64/boot/dts/compulab/Makefile              |  1 +
 .../boot/dts/compulab/mcm-imx8m-mini-rs485.dtsi    | 24 ++++++++++++++++++++++
 .../boot/dts/compulab/sbc-mcm-imx8m-mini-rs485.dts | 10 +++++++++
 3 files changed, 35 insertions(+)
 create mode 100644 arch/arm64/boot/dts/compulab/mcm-imx8m-mini-rs485.dtsi
 create mode 100644 arch/arm64/boot/dts/compulab/sbc-mcm-imx8m-mini-rs485.dts

diff --git a/arch/arm64/boot/dts/compulab/Makefile b/arch/arm64/boot/dts/compulab/Makefile
index dfc1daf6da4b..edfe6f987774 100644
--- a/arch/arm64/boot/dts/compulab/Makefile
+++ b/arch/arm64/boot/dts/compulab/Makefile
@@ -6,6 +6,7 @@ dtb-$(CONFIG_ARCH_FSL_IMX8MM) += ucm-imx8m-mini-m4.dtb
 dtb-$(CONFIG_ARCH_FSL_IMX8MM) += mcm-imx8m-mini.dtb
 dtb-$(CONFIG_ARCH_FSL_IMX8MM) += mcm-imx8m-mini-thermal.dtb
 dtb-$(CONFIG_ARCH_FSL_IMX8MM) += sbc-mcm-imx8m-mini.dtb
+dtb-$(CONFIG_ARCH_FSL_IMX8MM) += sbc-mcm-imx8m-mini-rs485.dtb
 
 always         := $(dtb-y)
 subdir-y       := $(dts-dirs)
diff --git a/arch/arm64/boot/dts/compulab/mcm-imx8m-mini-rs485.dtsi b/arch/arm64/boot/dts/compulab/mcm-imx8m-mini-rs485.dtsi
new file mode 100644
index 000000000000..5fab32e85945
--- /dev/null
+++ b/arch/arm64/boot/dts/compulab/mcm-imx8m-mini-rs485.dtsi
@@ -0,0 +1,24 @@
+/delete-node/ &pinctrl_uart4;
+
+&iomuxc {
+	mcm-imx8m-mini-rs485 {
+		pinctrl_uart4: uart4grp {
+			fsl,pins = <
+				MX8MM_IOMUXC_ECSPI2_MISO_GPIO5_IO12      0x140
+				MX8MM_IOMUXC_ECSPI2_MOSI_UART4_DCE_TX    0x140
+				MX8MM_IOMUXC_ECSPI2_SCLK_UART4_DCE_RX    0x140
+			>;
+		};
+	};
+};
+
+&uart4 { /* rs485 */
+	pinctrl-names = "default";
+	pinctrl-0 = <&pinctrl_uart4>;
+	assigned-clocks = <&clk IMX8MM_CLK_UART4_SRC>;
+	assigned-clock-parents = <&clk IMX8MM_SYS_PLL1_80M>;
+        linux,rs485-enabled-at-boot-time;
+        rs485-rts-active-high;
+        rts-gpios = <&gpio5 12 GPIO_ACTIVE_HIGH>;
+	status = "okay";
+};
diff --git a/arch/arm64/boot/dts/compulab/sbc-mcm-imx8m-mini-rs485.dts b/arch/arm64/boot/dts/compulab/sbc-mcm-imx8m-mini-rs485.dts
new file mode 100644
index 000000000000..193ec845217f
--- /dev/null
+++ b/arch/arm64/boot/dts/compulab/sbc-mcm-imx8m-mini-rs485.dts
@@ -0,0 +1,10 @@
+/dts-v1/;
+
+#include "mcm-imx8m-mini.dts"
+#include "mcm-imx8m-mini-rs485.dtsi"
+#include "sb-mcm-imx8-rev1.dtsi"
+
+/ {
+	model = "CompuLab MCM i.MX8MM on SB-MCM8M Rev 1.0";
+	compatible = "cpl,sbc-mcm-imx8m-mini", "cpl,mcm-imx8m-mini", "fsl,imx8mm";
+};
-- 
2.11.0

