From d94d9f79908f806f1a3fdcafde666aedf42cf12a Mon Sep 17 00:00:00 2001
From: Valentin Raevsky <valentin@compulab.co.il>
Date: Thu, 1 Apr 2021 11:17:12 +0300
Subject: [PATCH] mcm-imx8m-mini: dts: Add spidev example

Signed-off-by: Valentin Raevsky <valentin@compulab.co.il>
---
 arch/arm64/boot/dts/compulab/Makefile              |  1 +
 .../boot/dts/compulab/mcm-imx8m-mini-spidev.dtsi   | 48 ++++++++++++++++++++++
 .../dts/compulab/sbc-mcm-imx8m-mini-spidev.dts     | 10 +++++
 3 files changed, 59 insertions(+)
 create mode 100644 arch/arm64/boot/dts/compulab/mcm-imx8m-mini-spidev.dtsi
 create mode 100644 arch/arm64/boot/dts/compulab/sbc-mcm-imx8m-mini-spidev.dts

diff --git a/arch/arm64/boot/dts/compulab/Makefile b/arch/arm64/boot/dts/compulab/Makefile
index e76c90459b1f..bd7873ce03d7 100644
--- a/arch/arm64/boot/dts/compulab/Makefile
+++ b/arch/arm64/boot/dts/compulab/Makefile
@@ -6,6 +6,7 @@ dtb-$(CONFIG_ARCH_MXC) += mcm-imx8m-mini-m4.dtb
 dtb-$(CONFIG_ARCH_MXC) += mcm-imx8m-mini-thermal.dtb
 dtb-$(CONFIG_ARCH_MXC) += sbc-mcm-imx8m-mini.dtb
 dtb-$(CONFIG_ARCH_MXC) += sbc-mcm-imx8m-mini-rs485.dtb
+dtb-$(CONFIG_ARCH_MXC) += sbc-mcm-imx8m-mini-spidev.dtb
 
 always         := $(dtb-y)
 subdir-y       := $(dts-dirs)
diff --git a/arch/arm64/boot/dts/compulab/mcm-imx8m-mini-spidev.dtsi b/arch/arm64/boot/dts/compulab/mcm-imx8m-mini-spidev.dtsi
new file mode 100644
index 000000000000..4ed41b4cc20e
--- /dev/null
+++ b/arch/arm64/boot/dts/compulab/mcm-imx8m-mini-spidev.dtsi
@@ -0,0 +1,48 @@
+/* SB-MCM8M P20 header
+* P20.1  -- ECSPI3_SS0
+* P20.3  -- ECSPI3_MISO
+* P20.9  -- ECSPI3_MOSI
+* P20.11 -- ECSPI3_SCLK
+*/
+
+&iomuxc {
+	mcm-imx8m-mini-spidev {
+		pinctrl_ecspi3: ecspi3grp {
+			fsl,pins = <
+				MX8MM_IOMUXC_UART2_RXD_ECSPI3_MISO	0x140
+				MX8MM_IOMUXC_UART1_TXD_ECSPI3_MOSI	0x140
+				MX8MM_IOMUXC_UART1_RXD_ECSPI3_SCLK	0x140
+			>;
+		};
+
+		pinctrl_ecspi3_cs: ecspi3cs {
+			fsl,pins = <
+				MX8MM_IOMUXC_UART2_TXD_GPIO5_IO25	0x40000
+			>;
+		};
+	};
+};
+
+&ecspi3 {
+	#address-cells = <1>;
+	#size-cells = <0>;
+	fsl,spi-num-chipselects = <1>;
+	pinctrl-names = "default";
+	pinctrl-0 = <&pinctrl_ecspi3 &pinctrl_ecspi3_cs>;
+	cs-gpios = <&gpio5 25 GPIO_ACTIVE_LOW>;
+	status = "okay";
+
+	spidev1: spi@0 {
+		reg = <0>;
+		compatible = "rohm,dh2228fv";
+		spi-max-frequency = <500000>;
+	};
+};
+
+&uart1 {
+	status = "disabled";
+};
+
+&uart2 {
+	status = "disabled";
+};
diff --git a/arch/arm64/boot/dts/compulab/sbc-mcm-imx8m-mini-spidev.dts b/arch/arm64/boot/dts/compulab/sbc-mcm-imx8m-mini-spidev.dts
new file mode 100644
index 000000000000..023674c9a748
--- /dev/null
+++ b/arch/arm64/boot/dts/compulab/sbc-mcm-imx8m-mini-spidev.dts
@@ -0,0 +1,10 @@
+/dts-v1/;
+
+#include "mcm-imx8m-mini.dts"
+#include "mcm-imx8m-mini-spidev.dtsi"
+#include "sb-mcm-imx8-rev1.dtsi"
+
+/ {
+	model = "CompuLab MCM i.MX8MM on SB-MCM8M Rev 1.0";
+	compatible = "cpl,sbc-mcm-imx8m-mini", "cpl,mcm-imx8m-mini", "fsl,imx8mm";
+};
-- 
2.11.0

