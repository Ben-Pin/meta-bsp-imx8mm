From 148f4561045dcd000949d5ab08ad255d4da08d29 Mon Sep 17 00:00:00 2001
From: Valentin Raevsky <valentin@compulab.co.il>
Date: Tue, 5 Feb 2019 17:37:05 +0200
Subject: [PATCH 5/8] panel-ilitek-ili9881c: update #0

Signed-off-by: Valentin Raevsky <valentin@compulab.co.il>
---
 drivers/gpu/drm/panel/panel-ilitek-ili9881c.c | 21 +++++++++++++--------
 1 file changed, 13 insertions(+), 8 deletions(-)

diff --git a/drivers/gpu/drm/panel/panel-ilitek-ili9881c.c b/drivers/gpu/drm/panel/panel-ilitek-ili9881c.c
index f9b3ebc..ece7057 100644
--- a/drivers/gpu/drm/panel/panel-ilitek-ili9881c.c
+++ b/drivers/gpu/drm/panel/panel-ilitek-ili9881c.c
@@ -19,6 +19,9 @@
 #include <drm/drm_modes.h>
 #include <drm/drm_panel.h>
 
+#include <linux/of_device.h>
+#include <linux/of_gpio.h>
+
 #include <video/mipi_display.h>
 
 struct ili9881c {
@@ -27,7 +30,7 @@ struct ili9881c {
 
 	struct backlight_device *backlight;
 	struct regulator	*power;
-	struct gpio_desc	*reset;
+	int rst_gpio;
 };
 
 enum ili9881c_op {
@@ -294,6 +297,7 @@ static int ili9881c_send_cmd_data(struct ili9881c *ctx, u8 cmd, u8 data)
 	return 0;
 }
 
+#define stamp printk("%s %d\n",__func__,__LINE__)
 static int ili9881c_prepare(struct drm_panel *panel)
 {
 	struct ili9881c *ctx = panel_to_ili9881c(panel);
@@ -307,10 +311,10 @@ static int ili9881c_prepare(struct drm_panel *panel)
 	msleep(5);
 
 	/* And reset it */
-	gpiod_set_value(ctx->reset, 1);
+	gpio_set_value_cansleep(ctx->rst_gpio, 1);
 	msleep(20);
 
-	gpiod_set_value(ctx->reset, 0);
+	gpio_set_value_cansleep(ctx->rst_gpio, 0);
 	msleep(20);
 
 	for (i = 0; i < ARRAY_SIZE(ili9881c_init); i++) {
@@ -367,7 +371,7 @@ static int ili9881c_unprepare(struct drm_panel *panel)
 
 	mipi_dsi_dcs_enter_sleep_mode(ctx->dsi);
 	regulator_disable(ctx->power);
-	gpiod_set_value(ctx->reset, 1);
+	gpio_set_value_cansleep(ctx->rst_gpio, 1);
 
 	return 0;
 }
@@ -443,10 +447,10 @@ static int ili9881c_dsi_probe(struct mipi_dsi_device *dsi)
 		return PTR_ERR(ctx->power);
 	}
 
-	ctx->reset = devm_gpiod_get(&dsi->dev, "reset", GPIOD_OUT_LOW);
-	if (IS_ERR(ctx->reset)) {
-		dev_err(&dsi->dev, "Couldn't get our reset GPIO\n");
-		return PTR_ERR(ctx->reset);
+	ctx->rst_gpio = of_get_named_gpio(dsi->dev.of_node, "reset-gpio", 0);
+	if (!gpio_is_valid(ctx->rst_gpio)) {
+		dev_err(&dsi->dev, "Couldn't get panel reset pin available\n");
+		return -EINVAL;
 	}
 
 	np = of_parse_phandle(dsi->dev.of_node, "backlight", 0);
@@ -463,6 +467,7 @@ static int ili9881c_dsi_probe(struct mipi_dsi_device *dsi)
 		return ret;
 
 	dsi->mode_flags = MIPI_DSI_MODE_VIDEO_SYNC_PULSE;
+	dsi->mode_flags |= MIPI_DSI_MODE_VIDEO;
 	dsi->format = MIPI_DSI_FMT_RGB888;
 	dsi->lanes = 4;
 
-- 
1.9.1

